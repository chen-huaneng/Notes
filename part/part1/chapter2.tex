\chapter{Traveling Salesman Problem with Drone}

\section{Flying Sidekick Traveling Salesman Problem}
Flying Sidekick Traveling Salesman Problem (FSTSP) 由Murray(2015)等\cite{murrayFlyingSidekickTraveling2015}提出。

FSTSP数学模型的符号含义如表\ref{tab:fstsp-sign-meaning}。

\begin{table}[!htbp]
    \centering
    \caption{FSTSP模型符号及含义}
    \label{tab:fstsp-sign-meaning}
    \begin{tabularx}{\textwidth}{lX}
        \toprule[1pt] % 表头线宽1镑（point, pt）
        符号 & 含义 \\
        \midrule[0.75pt] % 表中间线宽0.75镑（point, pt）
        $0$ & 起点车场 \\
        $c + 1$ & 终点车场 \\
        $\mathbf{C}=\{1,2,\cdots,c\}$ & 全部客户集合 \\
        $\mathbf{C}' \subseteq \mathbf{C}$ & 无人机可访问的客户集合 \\
        $N_0 = \{0,1,2,\cdots,c\}$ & 流出节点集合 \\
        $N_+ = \{1,2,\cdots,c + 1\}$ & 流入节点集合 \\
        $N = \{0,1,2,\cdots,c,c + 1\}$ & 全部节点集合 \\
        $\langle i,j,k\rangle \in P, i \in N_0, j \in \mathbf{C}', j \neq i, k \in N_+, k \neq i, k \neq j$ & 无人机飞行路径集合（符合模型约束的路径） \\
        $\tau_{ij}'/\tau_{ij}$ & 弧$(i,j)$的飞行/行驶时间成本 \\
        $S_L/S_R$ & 无人机发射/回收耗时 \\
        $e$ & 无人机续航时长 \\
        $x_{ij} \in \{0,1\}$ & 卡车路由决策变量 \\
        $y_{ijk} \in \{0,1\}$ & 无人机路由决策变量 \\
        $1 \leq u_i \leq c + 2$ & 卡车破子圈辅助变量 \\
        $t_i'/t_i$ & 无人机/卡车有效到达时间戳辅助变量 \\
        $p_{ij} \in \{0,1\}$ & 无人机架次先后辅助变量 \\
        \bottomrule[1pt] % 表尾线宽1镑（point, pt）
    \end{tabularx}
\end{table}

FSTSP数学模型可以表示为MILP \ref{model:model-fstsp}。

{
\newcommand{\mySubstack}[1]{\mathclap{\substack{#1}}}
\begin{model}{FSTSP MILP}{model-fstsp}
\begin{align}
    \min \quad & t_{c + 1}  \label{eq:fstsp-obj}\\
    \text{s.t.} \quad & 
    \begin{coloredeq-green}[eq:fstsp-customer-visit]
        \sum_{\substack{i\in N_{0}\\i\neq j}}x_{ij}+\sum_{\substack{i\in N_{0}\\ i\neq j}}\!\sum_{\substack{k \in N_{+}\\ \langle i,j,k \rangle \in P}}y_{ijk}=1, \quad \forall j \in C
    \end{coloredeq-green}\\
    \quad & 
    \begin{coloredeq-purple}[eq:fstsp-truck-start]
        \sum_{j\in N_{+}}x_{0j}=1
    \end{coloredeq-purple}\\
    \quad & 
    \begin{coloredeq-purple}[eq:fstsp-truck-return]
        \sum_{i\in N_{0}}x_{i,c + 1}=1
    \end{coloredeq-purple}\\
    \quad & 
    \begin{coloredeq-purple}[eq:fstsp-truck-mtz]
        u_i - u_j + 1 \leq (c + 2)(1 - x_{ij}), \quad \forall i \in C, j \in \{N_{+}:j \neq i\}
    \end{coloredeq-purple}\\
    \quad & 
    \begin{coloredeq-purple}[eq:fstsp-truck-continuity]
        \sum_{\substack{i\in N_{0}\\ i \neq j}}x_{ij}=\sum_{\substack{k\in N_{+}\\k\neq j}}x_{jk}, \quad \forall j \in C
    \end{coloredeq-purple}\\
    \quad & 
    \begin{coloredeq-red}[eq:fstsp-drone-land]
        \sum_{\substack{j\in C\\j \neq i}}\!\sum_{\substack{k\in N_{+}\\\langle i,j,k \rangle\in P}}y_{ijk}\leq1, \quad \forall i\in N_{0}
    \end{coloredeq-red}\\
    \quad & 
    \begin{coloredeq-red}[eq:fstsp-drone-takeoff]
        \sum_{\substack{i\in N_{0}\\i\neq k}}\!\sum_{\substack{j\in C\\\langle i,j,k \rangle\in P}}y_{ijk}\leq1, \quad \forall k \in N_{+}
    \end{coloredeq-red}\\
    \quad & 
    \begin{coloredeq-yellow}[eq:fstsp-drone-truck-meet]
        2 y_{ijk} \leq \sum_{\substack{h \in N_0 \\ h \neq i}}x_{hi} + \sum_{\substack{l \in C\\ l \neq k}}x_{lk}, \quad \forall i \in C, j \in \{C: j \neq i\}, k \in \{N_{+}: \langle i,j,k \rangle \in P\}
    \end{coloredeq-yellow}\\
    \quad & 
    \begin{coloredeq-yellow}[eq:fstsp-drone-truck-meet-begin]
        y_{0jk} \leq \sum_{\substack{h \in N_0 \\ h \neq k}}x_{hk}, \quad \forall j \in C, k \in \{N_{+}: \langle 0,j,k \rangle \in P\}
    \end{coloredeq-yellow}\\
    \quad & 
    \begin{coloredeq-yellow}[eq:fstsp-truck-visit-order]
        u_k - u_i \geq 1 - (c+2)\left(1 - \sum_{\mySubstack{j \in C \\ \langle i,j,k \rangle \in P}}y_{ijk}\right), \quad \forall i \in C, k \in \{N_{+}: k \neq i\}
    \end{coloredeq-yellow}\\
    \quad & 
    \begin{coloredeq-yellow}[eq:fstsp-truck-drone-takeoff-time-1]
        t_i' \geq t_i - M\left(1 - \sum_{\substack{j \in C\\ j \neq i}}\sum_{\substack{k \in N_{+}\\ \langle i,j,k \rangle \in P}}y_{ijk}\right), \quad \forall i \in C
    \end{coloredeq-yellow}\\
    \quad & 
    \begin{coloredeq-yellow}[eq:fstsp-truck-drone-takeoff-time-2]
        t_i' \leq t_i + M\left(1 - \sum_{\substack{j \in C\\ j \neq i}}\sum_{\substack{k \in N_{+}\\ \langle i,j,k \rangle \in P}}y_{ijk}\right), \quad \forall i \in C
    \end{coloredeq-yellow}\\
    \quad & 
    \begin{coloredeq-yellow}[eq:fstsp-truck-drone-land-time-1]
        t_k' \geq t_k - M\left(1 - \sum_{\substack{i \in N_0\\ i \neq k}}\sum_{\substack{j \in C\\ \langle i,j,k \rangle \in P}}y_{ijk}\right), \quad \forall k \in N_{+}
    \end{coloredeq-yellow}\\
    \quad & 
    \begin{coloredeq-yellow}[eq:fstsp-truck-drone-land-time-2]
        t_k' \leq t_k + M\left(1 - \sum_{\substack{i \in N_0\\ i \neq k}}\sum_{\substack{j \in C\\ \langle i,j,k \rangle \in P}}y_{ijk}\right), \quad \forall k \in N_{+}
    \end{coloredeq-yellow}\\
    \quad & 
    \begin{aligned}\label{eq:fstsp-truck-time}
        &\begin{coloredeq-yellow}
            t_k \geq t_h + \tau_{hk} + s_{L}\left(\sum_{\substack{l \in C\\ l \neq k}}\sum_{\substack{m \in N_{+}\\ \langle k,l,m \rangle \in P}}y_{klm}\right) + s_{R}\left(\sum_{\substack{i \in N_0\\ i \neq k}}\sum_{\substack{j \in C\\ \langle i,j,k \rangle \in P}}y_{ijk}\right) - M(1 - x_{hk}), 
        \end{coloredeq-yellow}\\
        &\quad
        \begin{coloredeq-yellow}
            \forall h \in N_0, k \in \{N_{+}: k \neq h\}
        \end{coloredeq-yellow}
    \end{aligned}\\
    \quad & 
    \begin{coloredeq-red}[eq:fstsp-drone-time-fly]
        t_{j}'\geq t_{i}'+\tau_{ij}'-M\left(1 - \sum_{\mySubstack{k \in N_{+}\\ \langle i,j,k \rangle \in P}}y_{ijk}\right), \quad \forall j\in C', i \in \{N_0: i \neq j\}
    \end{coloredeq-red}\\
    \quad &
    \begin{coloredeq-red}[eq:fstsp-drone-time-fly-back]
        t_{k}'\geq t_{j}'+\tau_{jk}'+s_{R}-M\left(1-\sum_{\mySubstack{i\in N_{0}\\ \langle i,j,k\rangle \in P}}y_{ijk}\right), \quad \forall j\in C', k\in \{N_{+}: k \neq j\}
    \end{coloredeq-red}\\
    \quad & 
    \begin{coloredeq-red}[eq:fstsp-drone-endurance]
        t_k' - (t_j' - \tau_{ij}') \leq e + M(1 - y_{ijk}), \quad \forall k \in N_{+}, j \in \{C: j\neq k\}, i \in \{N_0: \langle i,j,k \rangle \in P\}
    \end{coloredeq-red}\\
    \quad &
    \begin{aligned}\label{eq:fstsp-drone-sortie-order}
        &\begin{coloredeq-red}
            t_l' \geq t_k' - M\left(3 - \sum_{\mySubstack{j \in C\\ \langle i,j,k \rangle \in P\\ j \neq l}}y_{ijk} - \sum_{\substack{m \in C \\ m \neq i\\ m \neq k \\ m \neq l}}\sum_{\substack{n \in N_{+}\\ \langle l,m,n\rangle \in P\\ n \neq i\\ n\neq k}}y_{lmn}-p_{il}\right)
        \end{coloredeq-red}\\
        &\quad
        \begin{coloredeq-red}
            \forall i \in N_0, k \in \{N_{+}: k \neq i\}, l \in \{C: l\neq i, l\neq k\}
        \end{coloredeq-red}
    \end{aligned}
\end{align}
\end{model}
}

约束\ref{eq:fstsp-obj}追求最小化卡车到达终点车场$c+1$的有效时间$t_{c+1}$，通过约束

约束条件可以分为四类\cite{zhihu-murray2015}：

\begin{itemize}
    \item \colorbox{shallow-green}{客户有关的约束：}约束\ref{eq:fstsp-customer-visit}要求对于任何一位顾客$j$，必须且只能被卡车（或无人机）服务一次。
    \item \colorbox{shallow-purple}{卡车有关的约束：}
    \begin{itemize}
        \item 卡车流平衡约束：约束\ref{eq:fstsp-truck-start}要求卡车从起点车场流出，约束\ref{eq:fstsp-truck-return}要求卡车从终点车场流入，约束\ref{eq:fstsp-truck-continuity}要求卡车在中间节点满足流入和流出相等的流平衡约束。
        \item 卡车破子圈约束：约束\ref{eq:fstsp-truck-mtz}是MTZ形式的破子圈约束\cite{YunChouorWeiWoYouHuaQianTanLuXingShangWenTiTSPDeQiZhongZhengShuGuiHuaMoXing2022, YunChouorWeiWoYouHua|TSPZhongLiangZhongBuTongXiaoChuZiHuanLuDeFangFaJicallbackShiXianPythonDiaoYongGurobiQiuJie2020}，去除了子圈存在的可能，这里$M$取到了$u_i - u_j + 1$的上界$c+2$，$u_i$可以理解为点$i$的访问次序，比如$u_1 = 5$可以理解为点1是从出发点开始，第五个被访问到的点。
    \end{itemize}
    \item \colorbox{shallow-red}{无人机有关的约束：}
    \begin{itemize}
        \item 无人机发射、回收节点流约束：约束\ref{eq:fstsp-drone-land}表示无人机可以从非终点车场流出，约束\ref{eq:fstsp-drone-takeoff}表示无人机可以从非起点车场流入。
        \item 无人机访问、回收节点时间戳约束：约束\ref{eq:fstsp-drone-time-fly}表示无人机访问顾客的时间戳应该符合时间逻辑，即不早于起飞时间戳$t_i'$+前往服务顾客点的飞行时长$\tau_{ij}'$，约束\ref{eq:fstsp-drone-time-fly-back}表示无人机回到卡车的时间戳应该符合时间逻辑，即不早于访问顾客点的$t_j'$+返回卡车的飞行时长$\tau_{jk}'$+回收无人机用时$s_R$。
        \item 无人机电量续航约束：约束\ref{eq:fstsp-drone-endurance}表示无人机的飞行时间不能超过其续航时间，即到达汇合点$t_k'$的有效时间-无人机的起飞时间$t_j'-\tau_{ij}'$（不直接使用$t_i'$是因为$t_i'$不是起飞的时间戳而是无人机到达$i$点的时间戳）要在无人机的续航时间$e$之内。
        \item 无人机飞行次序约束：约束\ref{eq:fstsp-drone-sortie-order}要求无人机对于任意两条路径$\langle i,j,k \rangle$和$\langle l,m,n \rangle$而言，如果无人机先访问顾客点$i$之后的某个时间才访问顾客点$l$（$p_{il}=1$），则无人机必须先完成上一次飞行才能继续下一次飞行（$t_l'\geq t_k'$），并且任意两条路径之间无交叉。
    \end{itemize}
    \item \colorbox{shallow-yellow}{无人机和卡车同步有关的约束：}
    \begin{itemize}
        \item 无人机发射、回收点卡车访问约束：约束\ref{eq:fstsp-drone-truck-meet}要求对于非起点发射的无人机（$\forall i \in C$），卡车必须经过无人机的起飞点$i$和降落点$k$，约束\ref{eq:fstsp-drone-truck-meet-begin}要求对于从起点车场起飞的无人机来说，卡车必须经过无人机的降落点。
        \item 无人机访问顾客时卡车访问次序约束：约束\ref{eq:fstsp-truck-visit-order}要求卡车必须先访问无人机的起飞点再访问无人机的降落点。
        \item 无人机发射点时间戳约束：约束\ref{eq:fstsp-truck-drone-takeoff-time-1}和\ref{eq:fstsp-truck-drone-takeoff-time-2}为无人机发射点的有效时间约束，要求无人机在发射节点的有效时间等于卡车在该点的有效时间，共同实现了卡车和无人机在发射节点时间上的对齐。
        \item 无人机回收点时间戳约束：约束\ref{eq:fstsp-truck-drone-land-time-1}和\ref{eq:fstsp-truck-drone-land-time-2}为无人机回收点的有效时间约束，要求无人机在回收节点的有效时间等于卡车在该点的有效时间，共同实现了卡车和无人机在回收节点时间上的对齐。
        \item 卡车访问顾客节点时间戳约束：约束\ref{eq:fstsp-truck-time}要求卡车访问当前顾客点$k$时必须要先将需要起飞的无人机$s_L$发射或者需要降落的无人机$s_R$回收，并且要大于到达顾客点$h$的有效时间戳+路径$\langle h,k \rangle$所花费的时间$\tau_{hk}$。
    \end{itemize}
\end{itemize}


\subsection{Flying Sidekick Traveling Salesman Problem with Multiple Drops}
